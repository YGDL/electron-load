C51 COMPILER V9.60.0.0   TEST1                                                             02/02/2020 23:32:40 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE TEST1
OBJECT MODULE PLACED IN .\Objects\test1.obj
COMPILER INVOKED BY: D:\Program Files (x86)\KEIL\C51\BIN\C51.EXE test1.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRI
                    -NT(.\Listings\test1.lst) TABS(2) OBJECT(.\Objects\test1.obj)

line level    source

   1          #include<STC15F2K60S2.H>
   2          #include<LCD.h>
   3          #include<DAC.h>
   4          
   5          sbit a=P3^2;              //EC11编码器a端，下降沿触发
   6          sbit b=P3^7;              //EC11编码器b端，高低电平判断正反旋
   7          sbit f=P3^6;              //EC11编码器按键，按下拉低电平
   8          
   9          int e=0,m=0;              //e为数据更改标志，m为光标位置数据
  10          long int c=0,v=0;           //数据存储（c为电流设定值，v为电压设定值）
  11          
  12          ///////////////////////////////////////////////////////////////////////////////////////
  13          /////////////////////////////初始化函数////////////////////////////////////////////////
  14          ///////////////////////////////////////////////////////////////////////////////////////
  15          
  16          void init_uart()            //串口初始化
  17          {
  18   1        TMOD=0x20;
  19   1        TH1=0xfd;
  20   1        TL1=0xfd;
  21   1        TR1=1;
  22   1        SM0=0;
  23   1        SM1=1;                //工作模式设定
  24   1        EA=1;               //开总中断
  25   1        ES=1;               //开串口中断
  26   1      }
  27          
  28          ///////////////////////////////////////////////////////////////////////////////////////
  29          
  30          void delay_ms(int y)
  31          {
  32   1        int j;
  33   1        for(;y>=0;y--)
  34   1          for(j=10;j>=0;j--);
  35   1      }
  36          
  37          long int pow(int m)           //次方函数
  38          {
  39   1        long int y=1;
  40   1        for(;m>0;m--)
  41   1        {
  42   2          y=y*10;
  43   2        }
  44   1        return(y);
  45   1      }
  46          ////////////////////////////////////////////////////////////////////////////////
  47          ///////////////////////////////中断初始化///////////////////////////////////////
  48          ////////////////////////////////////////////////////////////////////////////////
  49          
  50          void init_interrupt()         //中断初始化
  51          {
  52   1        IT0=1;                //指定外部中断0上升、下降沿触发，IT0
  53   1        EX0=1;                //使能外部中断
  54   1        EA=1;               //开总中断
C51 COMPILER V9.60.0.0   TEST1                                                             02/02/2020 23:32:40 PAGE 2   

  55   1      }
  56          ////////////////////////////////////////////////////////////////////////////////////
  57          ////////////////////////////////中断函数////////////////////////////////////////////
  58          ////////////////////////////////////////////////////////////////////////////////////
  59          
  60          void uart()interrupt 4          //串口中断函数
  61          {
  62   1        RI=0;               //软件清零，以产生下一次中断
  63   1      }
  64          void xuanzhuan()interrupt 0       //外部中断函数
  65          { 
  66   1        delay_ms(5);
  67   1        if(f==1)              //没按下旋钮
  68   1        {
  69   2          delay_ms(5);
  70   2          if(b==0)            //正旋
  71   2          {
  72   3            if(m<6)
  73   3            {
  74   4              c=c+pow(m);
  75   4              if(c>=999999)
  76   4                c=999999;
  77   4            }
  78   3            else
  79   3            {
  80   4              v=v+pow(m-6);
  81   4              if(v>=999999)
  82   4                v=999999;
  83   4            }
  84   3          }
  85   2          else              //逆旋
  86   2          {
  87   3            if(m<6)
  88   3            {
  89   4              c=c-pow(m);
  90   4              if(c<=0)
  91   4                c=0;
  92   4            }
  93   3            else
  94   3            {
  95   4              v=v-pow(m-6);
  96   4              if(v<=0)
  97   4                v=0;
  98   4            }
  99   3          }
 100   2          e=1;              //更新数字标志位
 101   2        }
 102   1        else                //按下旋钮
 103   1        {
 104   2          delay_ms(5);
 105   2          if(b==0)            //正旋
 106   2          {
 107   3            m=m-1;
 108   3            if(m<0)
 109   3              m=11;
 110   3          }
 111   2          else              //逆旋
 112   2          {
 113   3            m=m+1;
 114   3            P16=0;
 115   3            if(m>11)
 116   3              m=0;
C51 COMPILER V9.60.0.0   TEST1                                                             02/02/2020 23:32:40 PAGE 3   

 117   3          }
 118   2          e=1;              //更新位置标志位
 119   2        }
 120   1      }
 121          ////////////////////////////////////////////////////////////////////////////////
 122          ////////////////////////////////////主函数//////////////////////////////////////
 123          ////////////////////////////////////////////////////////////////////////////////
 124          void main()
 125          {
 126   1        init_interrupt();
 127   1        init_uart();
 128   1        init_LCD();
 129   1        while(1)
 130   1        {
 131   2          if(e==1)            //判断是否要写数据
 132   2          {
 133   3            if(m<6)
 134   3            {
 135   4              write_current();
 136   4            }
 137   3            else
 138   3            {
 139   4              write_voltage();
 140   4            }
 141   3            e=0;            //标志位清零
 142   3          }
 143   2          SBUF=c;
 144   2          while(!TI);
 145   2          TI=0;
 146   2          SBUF=v;
 147   2          while(!TI);
 148   2          TI=0;
 149   2          //write_DAC();          //调用DAC写函数
 150   2        }
 151   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    624    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
